<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>平台</title>
  <style>
    :root { --primary: #ef4444; --text: #111827; --muted: #6b7280; --bg: #f3f4f6; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif; }

    /* 固定列：頁首、通知列、頁尾 */
    #stage-header { position: fixed; top: 0; left: 0; right: 0; height: 12vh; background: #ffffff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 16px; z-index: 1000; }
    #stage-header .left { display: flex; align-items: center; gap: 12px; }
    #stage-header .photo { width: 80px; height: 80px; border-radius: 9999px; overflow: hidden; background: #e5e7eb; }
    #stage-header .photo img { width: 100%; height: 100%; object-fit: cover; }
    #stage-header .name { font-size: 36px; font-weight: 600; color: var(--text); }

    #stage-notice { position: fixed; top: 12vh; left: 0; right: 0; height: 10vh; background: #fee2e2; color: #000; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid #fca5a5; z-index: 999; }
    #stage-notice .text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 20px; }

    #stage-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 12vh; background: #ffffff; border-top: 1px solid #e5e7eb; display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; padding: 6px; z-index: 1000; }
    #stage-footer .btn { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #374151; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 6px 8px; cursor: pointer; }
    #stage-footer .btn .icon svg { width: 44px; height: 44px; display: block; }
    #stage-footer .btn .icon img { width: 44px; height: 44px; display: block; object-fit: cover; }
    #stage-footer .btn .label { font-size: 24px; line-height: 1; }
    #stage-footer .btn:hover { color: var(--primary); border-color: #fca5a5; }

    /* 中間內容：66% 高度 */
    #stage-content { position: fixed; top: 22vh; left: 0; right: 0; bottom: 12vh; overflow-y: auto; padding: 16px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 8px 20px -10px rgba(0,0,0,.15); padding: 16px; }
  </style>
</head>
<body>
  <!-- 頁首 12%：左側為社區照片與名稱，靠左對齊 -->
  <header id="stage-header">
    <div class="left">
      <div class="photo"><img id="stage-community-photo" alt="社區照片"></div>
      <div class="name" id="stage-community-name">社區名稱</div>
    </div>
  </header>

  <!-- 通知列 10%：固定在頁首下方 -->
  <div id="stage-notice">
    <div class="text" id="stage-notice-text">公告與通知訊息...</div>
  </div>

  <!-- 中間內容 66%：可滾動 -->
  <main id="stage-content">
    <div class="card">
      <h2 style="margin:0 0 8px 0; font-size:16px;">平台內容</h2>
      <p style="margin:0; color:#4b5563;">此區為平台的主要內容區塊（66% 高）。</p>
    </div>
  </main>

  <!-- 頁尾 12%：八個按鈕 -->
  <footer id="stage-footer">
    <button class="btn" aria-label="首頁">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 10l9-7 9 7v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10z" />
          <path d="M9 22V12h6v10" />
        </svg>
      </span>
      <span class="label">首頁</span>
    </button>

    <button class="btn" aria-label="公告">
      <span class="icon">
        <!-- 換成「鈴鐺」圖示 -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2z" />
          <path d="M18 16v-5a6 6 0 0 0-12 0v5" />
          <path d="M5 16h14" />
        </svg>
      </span>
      <span class="label">公告</span>
    </button>

    <button class="btn" aria-label="郵務">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="18" height="14" rx="2" ry="2" />
          <path d="M3 7l9 6 9-6" />
        </svg>
      </span>
      <span class="label">郵務</span>
    </button>

    <button class="btn" aria-label="訪客">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="8" r="3" />
          <path d="M4 20a8 8 0 0 1 16 0" />
        </svg>
      </span>
      <span class="label">訪客</span>
    </button>

    <button class="btn" aria-label="服務">
      <span class="icon">
        <!-- 換成「工具箱」圖示 -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="7" width="18" height="12" rx="2" />
          <path d="M9 7V5h6v2" />
          <path d="M3 12h18" />
        </svg>
      </span>
      <span class="label">服務</span>
    </button>

    <button class="btn" aria-label="住戶">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="8" cy="9" r="3" />
          <circle cx="16" cy="9" r="3" />
          <path d="M2 20a6 6 0 0 1 12 0" />
          <path d="M10 20a6 6 0 0 1 12 0" />
        </svg>
      </span>
      <span class="label">住戶</span>
    </button>

    <button class="btn" aria-label="預約">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="18" height="16" rx="2" />
          <path d="M16 3v4" />
          <path d="M8 3v4" />
          <path d="M3 11h18" />
        </svg>
      </span>
      <span class="label">預約</span>
    </button>

    <button class="btn" aria-label="任務">
      <span class="icon">
        <!-- 換成「清單勾選」圖示 -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 6h11" />
          <path d="M9 12h11" />
          <path d="M9 18h11" />
          <path d="M4 6l2 2 3-3" />
          <path d="M4 12l2 2 3-3" />
          <path d="M4 18l2 2 3-3" />
        </svg>
      </span>
      <span class="label">任務</span>
    </button>
  </footer>

  <script type="module">
    // 初始化頁首（從 localStorage）
    (function initHeader() {
      const name = localStorage.getItem('currentCommunityName') || '社區名稱';
      const photo = localStorage.getItem('currentCommunityPhotoUrl') || '';
      const nameEl = document.getElementById('stage-community-name');
      const imgEl = document.getElementById('stage-community-photo');
      nameEl.textContent = name;
      if (photo) { imgEl.src = photo; imgEl.style.display = ''; } else { imgEl.style.display = 'none'; }
    })();

    // 載入 Firebase 並讀取社區 A/B 按鈕設定（預設使用 A 頁）
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const userFirebaseConfig = {
      apiKey: "AIzaSyD4Cc7Gsasy5rD5-VdyIRslUF6iEJ_A3lk",
      authDomain: "nw-app-2025.firebaseapp.com",
      projectId: "nw-app-2025",
      storageBucket: "nw-app-2025.appspot.com",
      messagingSenderId: "795564245715",
      appId: "1:795564245715:web:5e459d6123824ee1104a26",
      measurementId: "G-DK4NLS4Q57"
    };
    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : userFirebaseConfig;
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : (firebaseConfig.appId || 'default-app-id');

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const selectedCommunityId = localStorage.getItem('currentCommunityId') || '';

    function appButtonDefaultsDoc() {
      return doc(db, 'artifacts', appId, 'settings', 'buttonDefaults');
    }
    function communityDoc(id) {
      return doc(db, 'artifacts', appId, 'communities', id);
    }

    const defaultItem = { name: '', imageUrl: '', linkType: 'internal', linkTarget: '' };
    const norm8 = (arr) => {
      const base = Array.isArray(arr) ? arr.slice(0, 8) : [];
      while (base.length < 8) base.push({ ...defaultItem });
      return base.map(it => ({
        name: it?.name || '',
        imageUrl: it?.imageUrl || '',
        linkType: it?.linkType === 'external' ? 'external' : 'internal',
        linkTarget: it?.linkTarget || ''
      }));
    };

    async function loadButtons() {
      try {
        const defSnap = await getDoc(appButtonDefaultsDoc());
        const defaults = defSnap.exists() ? defSnap.data() : { A: [], B: [] };
        let itemsA = norm8(defaults.A);
        // 嘗試讀取社區設定
        if (selectedCommunityId) {
          const cSnap = await getDoc(communityDoc(selectedCommunityId));
          if (cSnap.exists()) {
            const data = cSnap.data() || {};
            const bs = data.buttonSettings || {};
            const hasA = Array.isArray(bs.A) && bs.A.some(x => !!(x && (x.name || x.imageUrl || x.linkTarget)));
            itemsA = norm8(hasA ? bs.A : itemsA);
          }
        }
        applyButtons(itemsA);
      } catch (err) {
        console.warn('載入社區按鈕設定失敗，使用預設或現有標籤。', err);
      }
    }

    function applyButtons(items) {
      const btns = Array.from(document.querySelectorAll('#stage-footer .btn'));
      btns.forEach((btn, idx) => {
        const item = items[idx] || defaultItem;
        const labelEl = btn.querySelector('.label');
        const iconEl = btn.querySelector('.icon');
        if (item.name) labelEl.textContent = item.name;
        if (item.imageUrl) {
          iconEl.innerHTML = `<img src="${item.imageUrl}" alt="icon" />`;
        }
        // 綁定導向
        btn.onclick = () => {
          const target = item.linkTarget || '';
          if (!target) return;
          if (item.linkType === 'external') {
            window.open(target, '_blank');
          } else {
            // 內部導向：相對或絕對路徑
            window.location.href = target;
          }
        };
      });
    }

    loadButtons();
  </script>
</body>
</html>